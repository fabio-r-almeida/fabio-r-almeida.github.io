<!DOCTYPE html>
<head>    
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oeiras Valley Project 2022</title>
    <link rel="icon" type="image/x-icon" href="img/oeiras_valley_icon.png">

    
        <script>
            L_NO_TOUCH = false;
            L_DISABLE_3D = false;
        </script>
    
    <style>html, body {width: 100%;height: 100%;margin: 0;padding: 0;}</style>
    <style>#map {position:absolute;top:0;bottom:0;right:0;left:0;}</style>
    <script src = "./oeiras.js"></script> <!--coordenadas de Oeiras-->

    <link rel="stylesheet" href="./style/style.css"> <!--Style da navigation bar-->

  
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.6.0/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.6.0/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css"/>
    

    <!--marker clusters-->
    <link rel="stylesheet" href="./Cluster/MarkerCluster.css">
    <link rel="stylesheet" href="./Cluster/MarkerCluster.Default.css">
    <script src = "./Cluster/leaflet.markercluster.js"></script> <!--marker cluster-->
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.10/lodash.min.js"></script>


            <style>
                #map {
                    position: relative;
                    width: 100.0%;
                    height: 80.0%;
                    left: 0.0%;
                    top: 0.0%;
                }
            </style>
        
</head>
<body style="background-color: black;">    

    <div class="header" >
       
        <div class="header-right">
          <a class="active" href="#home">Home</a>
          <a href="#contact">Contact</a>
          <a href="#about">About</a>
        </div>
      </div>
      
      <div id="map" ></div>
    
</body>


<script>  
//auto-update variable for parking:
var old_parking;
var update = true;

var types = ["deficientes","ev","pagos","parking"];
var loop = 0;


function auto_update(){

    loop = loop + 1;
    if(loop >3)
    loop=0;


    var currentDate = new Date();
    var timestamp = currentDate.getTime();
    $.get( "./parking/"+types[loop]+".geojson?"+timestamp, function( data ) {
    if(_.isEqual(data, old_parking))
    update = false;
    else 
    update = true;
   
    old_parking = data;
    
    
});
     
}



 
 L.Mask = L.Polygon.extend({
	options: {
		stroke: false,
		color: '#333',
		fillOpacity: 0.5,
		clickable: true,

		outerBounds: new L.LatLngBounds([-90, -360], [90, 360])
	},

	initialize: function (latLngs, options) {
        
         var outerBoundsLatLngs = [
			this.options.outerBounds.getSouthWest(),
			this.options.outerBounds.getNorthWest(),
			this.options.outerBounds.getNorthEast(),
			this.options.outerBounds.getSouthEast()
		];
        L.Polygon.prototype.initialize.call(this, [outerBoundsLatLngs, latLngs], options);	
	},

});
L.mask = function (latLngs, options) {
	return new L.Mask(latLngs, options);
};

var lat = 38.712088;
var lng =  -9.267999;
var zoom =  1;

const view_width = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0)
if (view_width<=500)
minimo_zoom = 12;
else
minimo_zoom = 13;

var osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
var sateliteUrl = 'https://api.mapbox.com/styles/v1/frdalmeida/cl1igqvos003f14q42wl56har/tiles/256/{z}/{x}/{y}@2x?access_token=pk.eyJ1IjoiZnJkYWxtZWlkYSIsImEiOiJja3dxZGlpeHowbG5qMnZwbTMwZWtpa2kyIn0.-409cG2gqLjp4MmMll3nwg';
var osmAttrib='Project - Oeiras Valley Award';

var osm = new L.TileLayer(osmUrl, {minZoom: minimo_zoom, maxNativeZoom: 19,maxZoom: 22, attribution: osmAttrib});
var satelite = new L.TileLayer(sateliteUrl, {minZoom: minimo_zoom, maxNativeZoom: 19,maxZoom: 22, attribution: osmAttrib});


var map = new L.Map('map', {
maxBounds: [[38.6532, -9.1562], [38.7716, -9.3846]],
layers:[osm, satelite]
});

map.on('drag', function() {map.panInsideBounds([[38.6532, -9.1562],[38.7716, -9.3846]], { animate: false });
});



map.setView(new L.LatLng(lat, lng), zoom);

// transform geojson coordinates into an array of L.LatLng
var coordinates = oeiras.features[0].geometry.coordinates[0];
var latLngs = [];
for (i=0; i<coordinates.length; i++) {
    latLngs.push(new L.LatLng(coordinates[i][1], coordinates[i][0]));
}

L.mask(latLngs).addTo(map);

var myStyle = {
    "color": "#3b5a87",
    "weight": 2,
    "fillColor" : "none",
    "opacity": 1
};

var layerpoly = new L.geoJson(oeiras.features,myStyle).addTo(map);

// adicionar markers ao mapa

const geojsonMarkerOptions = {
    radius: 8,
    fillColor: "orange",
    color: "#000",
    weight: 1,
    opacity: 1,
    fillOpacity: 0.8
}



var markers = L.markerClusterGroup();
setInterval(function () {
    
    

    auto_update();
    
    if(update==true){   
            markers.clearLayers();
        L.geoJSON(old_parking, {
            pointToLayer: function(feature, latlng){
                return markers.addLayer(L.circleMarker(latlng, geojsonMarkerOptions))
            }
        });
        map.addLayer(markers);
}


}, 2000);



     
</script>